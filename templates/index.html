<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Summa</title>

    <!-- PWA Meta Tags -->
    <meta
      name="description"
      content="Manage and analyze your invoices and expenses"
    />
    <meta name="theme-color" content="#3b82f6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Summa" />

    <!-- Favicon & Icons -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="{{ url_for('static', filename='favicon.svg') }}"
    />
    <link
      rel="apple-touch-icon"
      href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}"
    />
    <link
      rel="manifest"
      href="{{ url_for('static', filename='manifest.json') }}"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <div class="logo-icon">&Sigma;</div>
          <span>Summa</span>
        </div>
        <div class="view-toggle">
          <button
            class="view-toggle-btn active"
            data-view="invoices"
            onclick="showInvoicesView()"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
              />
              <polyline points="14 2 14 8 20 8" />
              <line x1="16" y1="13" x2="8" y2="13" />
              <line x1="16" y1="17" x2="8" y2="17" />
            </svg>
            <span>Invoices</span>
          </button>
          <button
            class="view-toggle-btn"
            data-view="stats"
            onclick="showStatsView()"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="20" x2="18" y2="10" />
              <line x1="12" y1="20" x2="12" y2="4" />
              <line x1="6" y1="20" x2="6" y2="14" />
            </svg>
            <span>Statistics</span>
          </button>
        </div>
        <div class="header-actions">
          <button
            class="btn btn-secondary"
            onclick="openImportModal()"
            title="JSON Import"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
            <span class="btn-text">Import</span>
          </button>
          <button
            class="btn btn-primary"
            onclick="openAddModal()"
            title="New Invoice"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            <span class="btn-text">New</span>
          </button>
        </div>
      </div>
    </header>

    <main class="container">
      <!-- Filters -->
      <div class="filters">
        <!-- Quick Filters -->
        <div class="quick-filters">
          <button
            class="quick-filter-btn"
            data-filter="week"
            onclick="
              applyFilter('week');
              loadInvoices();
            "
          >
            Week
          </button>
          <button
            class="quick-filter-btn active"
            data-filter="month"
            onclick="
              applyFilter('month');
              loadInvoices();
            "
          >
            Month
          </button>
          <button
            class="quick-filter-btn"
            data-filter="year"
            onclick="
              applyFilter('year');
              loadInvoices();
            "
          >
            Year
          </button>
          <button
            class="quick-filter-btn"
            data-filter="all"
            onclick="
              applyFilter('all');
              loadInvoices();
            "
          >
            All
          </button>
        </div>

        <!-- Period Navigator -->
        <div class="month-navigator">
          <button class="month-nav-btn" onclick="navigateToPrevious()">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="15 18 9 12 15 6" />
            </svg>
          </button>
          <div class="month-display" id="month-display">January 2026</div>
          <button class="month-nav-btn" onclick="navigateToNext()">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="9 18 15 12 9 6" />
            </svg>
          </button>
          <button class="month-reset-btn" onclick="resetToCurrent()">
            Current Month
          </button>
        </div>

        <!-- Search (always visible) -->
        <div class="filter-search-mobile">
          <div class="form-group">
            <label class="form-label">Search</label>
            <input
              type="text"
              class="form-input"
              id="search"
              placeholder="Search store or item..."
            />
          </div>
        </div>

        <!-- Advanced Filters Toggle (mobile only) -->
        <button
          class="filters-advanced-toggle"
          id="filters-toggle"
          onclick="toggleAdvancedFilters()"
        >
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
          </svg>
          <span>Advanced Filters</span>
          <svg
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="6 9 12 15 18 9" />
          </svg>
        </button>

        <!-- Advanced Filters Grid -->
        <div class="filters-grid" id="filters-grid">
          <div class="form-group filter-desktop-search">
            <label class="form-label">Search</label>
            <input
              type="text"
              class="form-input"
              id="search-desktop"
              placeholder="Search store or item..."
            />
          </div>
          <div class="form-group">
            <label class="form-label">Store</label>
            <select class="form-select" id="store-filter">
              <option value="">All Stores</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Category</label>
            <select class="form-select" id="type-filter">
              <option value="">All Categories</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">From</label>
            <input type="date" class="form-input" id="date-from" />
          </div>
          <div class="form-group">
            <label class="form-label">To</label>
            <input type="date" class="form-input" id="date-to" />
          </div>
          <div class="form-group">
            <label class="form-label">Sort By</label>
            <select class="form-select" id="sort-by">
              <option value="date">Date</option>
              <option value="store">Store</option>
              <option value="total">Amount</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Order</label>
            <select class="form-select" id="sort-order">
              <option value="desc">Descending</option>
              <option value="asc">Ascending</option>
            </select>
          </div>
        </div>
        <div class="filter-reset-row">
          <button
            class="btn btn-secondary btn-sm filter-reset-btn"
            onclick="resetAllFilters()"
          >
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
              <path d="M3 3v5h5" />
            </svg>
            Reset Filters
          </button>
        </div>
      </div>

      <!-- Invoices List -->
      <div class="invoices-section" id="invoices-view">
        <div class="section-header">
          <div class="section-header-left">
            <label class="invoice-checkbox" id="select-all-checkbox">
              <input type="checkbox" onchange="toggleSelectAll(this.checked)" />
              <span class="checkbox-mark"></span>
            </label>
            <span class="section-title" id="results-count">0 Invoices</span>
          </div>
          <span class="section-total" id="results-total">0.00</span>
        </div>
        <div class="invoice-list" id="invoice-list">
          <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <div class="empty-title">No invoices yet</div>
            <div class="empty-text">
              Add a new invoice or import existing data.
            </div>
          </div>
        </div>
      </div>

      <!-- Statistics View -->
      <div class="stats-view" id="stats-view" style="display: none">
        <!-- Summary Cards -->
        <div class="stats-cards">
          <div class="stat-card">
            <div class="stat-label">Total</div>
            <div class="stat-value currency" id="stats-total">0.00</div>
            <div class="stat-change" id="stats-change"></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Invoices</div>
            <div class="stat-value" id="stats-count">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Average</div>
            <div class="stat-value currency" id="stats-average">0.00</div>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="stats-charts">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">By Category</h3>
            </div>
            <div class="chart-container">
              <canvas id="category-chart"></canvas>
            </div>
            <div class="chart-legend" id="category-legend"></div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Top Stores</h3>
            </div>
            <div class="chart-container chart-container-bar">
              <canvas id="store-chart"></canvas>
            </div>
          </div>
        </div>

        <!-- Empty State for Stats -->
        <div class="stats-empty" id="stats-empty" style="display: none">
          <div class="empty-state">
            <div class="empty-icon">üìä</div>
            <div class="empty-title">No data available</div>
            <div class="empty-text">
              There are no invoices for this time period.
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Add Invoice Modal -->
    <div class="modal-overlay" id="add-modal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">New Invoice</h3>
          <button class="modal-close" onclick="closeAddModal()">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <form id="add-form">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Date</label>
                <input
                  type="date"
                  class="form-input"
                  id="invoice-date"
                  required
                />
              </div>
              <div class="form-group">
                <label class="form-label">Store</label>
                <input
                  type="text"
                  class="form-input"
                  id="invoice-store"
                  placeholder="e.g. Amazon"
                  required
                />
              </div>
            </div>
            <div class="form-group" style="margin-bottom: 1rem">
              <label class="form-label">Category</label>
              <input
                type="text"
                class="form-input"
                id="invoice-type"
                placeholder="e.g. Groceries, Restaurant, Electronics"
                list="type-suggestions"
              />
              <datalist id="type-suggestions"></datalist>
            </div>

            <div class="items-input-section">
              <div class="items-header">
                <h4>Items</h4>
                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  onclick="addItemRow()"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                  </svg>
                  Add Item
                </button>
              </div>
              <div id="items-container">
                <div class="item-input-row">
                  <div class="form-group">
                    <label class="form-label">Item Name</label>
                    <input
                      type="text"
                      class="form-input item-name"
                      placeholder="Product name"
                    />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Price</label>
                    <input
                      type="number"
                      step="0.01"
                      class="form-input item-price"
                      placeholder="0.00"
                    />
                  </div>
                  <button
                    type="button"
                    class="btn btn-danger btn-sm"
                    onclick="removeItemRow(this)"
                    style="margin-bottom: 0.375rem"
                  >
                    <svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <line x1="18" y1="6" x2="6" y2="18" />
                      <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                  </button>
                </div>
              </div>
              <div class="calculated-total">
                <span class="calculated-total-label">Calculated Total</span>
                <span class="calculated-total-value" id="calculated-total"
                  >‚Ç¨0.00</span
                >
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeAddModal()">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveInvoice()">
            Save
          </button>
        </div>
      </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="import-modal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">JSON Import</h3>
          <button class="modal-close" onclick="closeImportModal()">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="dropzone" id="dropzone">
            <div class="dropzone-icon">üìÅ</div>
            <div class="dropzone-text">
              Drag JSON files here or click to select<br /><small
                style="color: var(--text-muted)"
                >Multiple files supported</small
              >
            </div>
            <input
              type="file"
              id="file-input"
              accept=".json"
              multiple
              style="display: none"
            />
          </div>
          <div
            id="selected-files"
            style="display: none; margin-bottom: 1rem"
          ></div>
          <div class="form-group">
            <label class="form-label">Or paste JSON directly</label>
            <textarea
              class="form-input json-textarea"
              id="json-input"
              placeholder='[{"date": "2024-01-01", "store": "...", "total": "...", "items": [...]}]'
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeImportModal()">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="importJson()">
            Import
          </button>
        </div>
      </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div class="modal-overlay" id="bulk-edit-modal">
      <div class="modal" style="max-width: 400px">
        <div class="modal-header">
          <h3 class="modal-title">Bulk Edit</h3>
          <button class="modal-close" onclick="closeBulkEditModal()">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <p style="margin-bottom: 1rem; color: var(--text-secondary)">
            <span id="bulk-edit-count">0</span> invoice(s) selected
          </p>
          <div class="form-group">
            <label class="form-label">New Store Name</label>
            <input
              type="text"
              class="form-input"
              id="bulk-edit-store"
              placeholder="e.g. Walmart (leave empty to keep unchanged)"
            />
          </div>
          <div class="form-group">
            <label class="form-label">New Category</label>
            <input
              type="text"
              class="form-input"
              id="bulk-edit-category"
              list="bulk-category-suggestions"
              placeholder="e.g. Groceries (leave empty to keep unchanged)"
            />
            <datalist id="bulk-category-suggestions"></datalist>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeBulkEditModal()">
            Cancel
          </button>
          <button class="btn btn-primary" onclick="saveBulkEdit()">
            Save
          </button>
        </div>
      </div>
    </div>

    <!-- Bulk Action Toolbar -->
    <div class="bulk-action-toolbar" id="bulk-action-toolbar">
      <div class="bulk-action-content">
        <span class="bulk-action-count">
          <span id="selected-count">0</span> selected
        </span>
        <div class="bulk-action-buttons">
          <button
            class="btn btn-secondary btn-sm"
            onclick="selectAllInvoices()"
          >
            Select All
          </button>
          <button
            class="btn btn-secondary btn-sm"
            onclick="deselectAllInvoices()"
          >
            Deselect All
          </button>
          <button class="btn btn-primary btn-sm" onclick="openBulkEditModal()">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
              />
              <path
                d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
              />
            </svg>
            Edit
          </button>
          <button class="btn btn-danger btn-sm" onclick="bulkDeleteInvoices()">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="3 6 5 6 21 6" />
              <path
                d="m19 6-.867 12.142A2 2 0 0 1 16.138 20H7.862a2 2 0 0 1-1.995-1.858L5 6"
              />
              <path d="M10 11v6" />
              <path d="M14 11v6" />
              <path
                d="m8 6 .544-1.632A2 2 0 0 1 10.442 3h3.116a2 2 0 0 1 1.898 1.368L16 6"
              />
            </svg>
            Delete
          </button>
        </div>
      </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal-overlay" id="confirm-modal">
      <div class="modal" style="max-width: 400px">
        <div class="modal-header">
          <h3 class="modal-title" id="confirm-modal-title">
            Confirm Deletion
          </h3>
          <button class="modal-close" onclick="closeConfirmModal(false)">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <p id="confirm-modal-message" style="color: var(--text-secondary)">
            Are you sure you want to delete this entry?
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeConfirmModal(false)">
            Cancel
          </button>
          <button class="btn btn-danger" onclick="closeConfirmModal(true)">
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="3 6 5 6 21 6" />
              <path
                d="m19 6-.867 12.142A2 2 0 0 1 16.138 20H7.862a2 2 0 0 1-1.995-1.858L5 6"
              />
              <path d="M10 11v6" />
              <path d="M14 11v6" />
            </svg>
            Delete
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script
      src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"
      defer
    ></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
  </body>
</html>
